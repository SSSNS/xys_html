<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>æ ¡å›­æ€ç»Ÿè®¡è¡¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
:root{
  --primary:#1677ff;
  --danger:#ff4d4f;
  --bg:#f5f7fa;
}

*{
  box-sizing:border-box;
  -webkit-tap-highlight-color: transparent;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);
  padding:16px;
}

h1{
  font-size:24px;
  margin-bottom:16px;
}

h2{
  font-size:20px;
  margin:0 0 12px 0;
}

.panel{
  background:#fff;
  padding:16px;
  border-radius:16px;
  box-shadow:0 6px 18px rgba(0,0,0,0.05);
  margin-bottom:16px;
}

/* ===== è§’è‰²ç½‘æ ¼ ===== */
.role-grid{
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:10px;
}

.role-btn{
  padding:12px 6px;
  border-radius:12px;
  border:1px solid #ddd;
  background:#fff;
  font-size:16px;
  font-weight:500;
  cursor:pointer;
  transition:0.15s;
}

.role-btn:active{
  transform:scale(0.96);
}

.role-btn.win{
  background:#d4f7dc;
  border-color:#30c46c;
}

.role-btn.lose{
  background:#ffd6d6;
  border-color:#ff4d4f;
}

/* ===== æ“ä½œæŒ‰é’® ===== */
.main-btn{
  padding:14px;
  border-radius:12px;
  border:none;
  font-weight:600;
  font-size:18px;
  width:100%;
  margin-bottom:10px;
  cursor:pointer;
}

.primary{
  background:var(--primary);
  color:#fff;
}

.danger{
  background:var(--danger);
  color:#fff;
}

.gray{
  background:#ddd;
}

/* ===== è¡¨æ ¼ç§»åŠ¨ä¼˜åŒ– ===== */
#resultArea{
  overflow-x:auto;
}

table{
  width:100%;
  min-width:300px;
  border-collapse:collapse;
}

th,td{
  padding:8px;
  text-align:center;
  border-bottom:1px solid #eee;
  font-size:16px;
}

/* ===== åº•éƒ¨å›ºå®šæ“ä½œåŒºï¼ˆç§»åŠ¨ç«¯ï¼‰===== */
@media (max-width:768px){

  body{
    padding-bottom:120px;
  }

  .bottom-fixed{
    position:fixed;
    left:0;
    right:0;
    bottom:0;
    background:#f5f5f5;
    padding:12px 16px calc(12px + env(safe-area-inset-bottom));
    box-shadow:0 -6px 18px 2px rgba(0,0,0,0.08);
  }

}
</style>
</head>
<body>

<h1>æ ¡å›­æ€ç»Ÿè®¡è¡¨</h1>

<div class="panel">
  <h2>ç¬¬ <span id="roundDisplay">1</span> åœº</h2>
  <div class="role-grid" id="roleGrid"></div>
  <br>
  <div class="bottom-fixed">
    <button class="main-btn primary" onclick="completeRound()">å®Œæˆæœ¬åœº</button>
    <button class="main-btn gray" onclick="clearData()">æ¸…ç©ºæ•°æ®</button>
  </div>
</div>

<div class="panel" id="resultArea">
  <h2>ç»Ÿè®¡ç»“æœ(<span id="matchDesc"></span>)</h2>
  <div>
    <table>
      <thead>
        <tr>
          <th>è§’è‰²</th>
          <th>ç™»åœº</th>
          <th>èƒœåœº</th>
          <th>ç™»åœºç‡</th>
          <th>èƒœç‡</th>
        </tr>
      </thead>
      <tbody id="resultBody"></tbody>
    </table>
  </div>
  <br>
  <button class="main-btn gray" onclick="saveImage()">ä¿å­˜ä¸ºå›¾ç‰‡</button>
</div>

<div class="panel">
  <h2>å¯¼å…¥ / å¯¼å‡º</h2>
  <textarea id="codeArea" style="width:100%;height:80px;"></textarea><br><br>
  <button class="main-btn primary" onclick="exportCode()">å¯¼å‡ºç¼–ç </button>
  <button class="main-btn primary" onclick="importCode()">å¯¼å…¥ç¼–ç </button>
</div>

<script>
const chars = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"

// ===== è§’è‰²åˆ—è¡¨ =====
const roles = [
  "ç™½èŒ¹ç´",
  "ç™½äº‘é¾™",
  "ç™½æ¢“é’°",
  "åŒ…åº†æ¢…",
  "è¿Ÿæµ·é¹°",
  "ä¸›è‰³",
  "è‘£ç¦è´¤",
  "æœæ¬£",
  "å‚…å¿ æ‰¬",
  "è‘›å±•å»·",
  "é¡¾ä¼Ÿåˆ©",
  "éƒ­æ®·",
  "éŸ©è¾‰",
  "éƒæ–°æ˜",
  "é»„å¾·å½¬",
  "å§œç¿ æ¢…",
  "å§œå£°æ²³",
  "é‡‘æƒä¼Ÿ",
  "é‡‘é’Ÿæ¤",
  "ææ¡‚ç²",
  "æå˜‰",
  "æå›ç§‘",
  "æä¸½ç‡•",
  "æ—ä¸­ç§‹",
  "åˆ˜æŸå…µ",
  "åˆ˜å¥",
  "åˆ˜é™",
  "é©¬å®",
  "é©¬å¿—ç§‘",
  "å­Ÿä»¤æ–Œ",
  "å­Ÿè‰³",
  "æ½˜é™",
  "çŸ³ç£Š",
  "å­™å½¬",
  "å­™å†°",
  "å­™æ¡‚è‰º",
  "å­™è‰³æ¢…",
  "é™¶é˜³",
  "ä¸‡æ…§é¦¨",
  "ç‹ç„¶",
  "ç‹ç‘èŠ±",
  "ç‹è·ƒè¿›",
  "é‚¢çº",
  "æ¨å…‰å®‡",
  "æ¨å‰",
  "æ¨æ—­å",
  "äºæ¶¦æ³½",
  "å¼ æ·‘èŠ³",
  "å¼ æ˜€",
  "èµµå¾·è´¤",
  "èµµæ¬£æ¬£",
  "éƒ‘å½¤",
  "éƒ‘æ™“ä¼Ÿ",
  "å‘¨æ°",
  "æœ±åˆšç´",
  "æœ±æ™“ä¸œ",
]

let currentRound = 1
let matches = []
let currentSelection = {}

const roleGrid = document.getElementById("roleGrid")

// åˆå§‹åŒ–è§’è‰²æŒ‰é’®
roles.forEach((role,index)=>{
  const btn = document.createElement("button")
  btn.className = "role-btn"
  btn.innerText = role
  btn.onclick = ()=>toggleRole(index,btn)
  roleGrid.appendChild(btn)
})

// ç‚¹å‡»å¾ªç¯ï¼šæœªé€‰ â†’ èƒœ â†’ è´Ÿ â†’ æœªé€‰
function toggleRole(index,btn){
  if(!currentSelection[index]){
    currentSelection[index] = "win"
    btn.classList.add("win")
  }else if(currentSelection[index]==="win"){
    currentSelection[index] = "lose"
    btn.classList.remove("win")
    btn.classList.add("lose")
  }else{
    delete currentSelection[index]
    btn.classList.remove("lose")
  }
}

// å®Œæˆæœ¬åœº
function completeRound(){
  const win = []
  const lose = []
  for(const k in currentSelection){
    if(currentSelection[k]==="win") win.push(Number(k))
    if(currentSelection[k]==="lose") lose.push(Number(k))
  }

  if(win.length===0 && lose.length===0){
    alert("æœ¬åœºæœªé€‰æ‹©è§’è‰²")
    return
  }

  matches.push({w:win,l:lose})
  currentRound++
  currentSelection={}
  resetButtons()
  updateStats()
}

// é‡ç½®æŒ‰é’®çŠ¶æ€
function resetButtons(){
  document.querySelectorAll(".role-btn").forEach(btn=>{
    btn.classList.remove("win")
    btn.classList.remove("lose")
  })
  document.getElementById("roundDisplay").innerText=currentRound
}

// å®æ—¶ç»Ÿè®¡
function updateStats(){
  const stats = {}
  roles.forEach((r,i)=>{
    stats[i]={appear:0,win:0,lose:0}
  })

  matches.forEach(m=>{
    m.w.forEach(i=>{
      stats[i].appear++
      stats[i].win++
    })
    m.l.forEach(i=>{
      stats[i].appear++
      stats[i].lose++
    })
  })

  const body=document.getElementById("resultBody")
  body.innerHTML=""

  const desc=document.getElementById("matchDesc")
  desc.innerHTML=`å…±${matches.length}åœº`

  const roleDatas = [];
  roles.forEach((r,i)=>{
    if(stats[i].appear>0){
      roleDatas.push([
        r, // è§’è‰²å
        stats[i].appear, // ç™»åœºæ•° 
        stats[i].win, // èƒœåœº
        Math.round(100 * stats[i].appear / matches.length), // ç™»åœºç‡
        Math.round(100 * stats[i].win / (stats[i].win + stats[i].lose)), // èƒœç‡
      ]);
    }
  })

  let appearArr = roleDatas.map(el => el[1]);
  appearArr.sort((a, b) => b-a);
  let winArr = roleDatas.map(el => el[2]);
  winArr.sort((a, b) => b-a);

  roleDatas.forEach((data)=>{
    const tr=document.createElement("tr");
    const appearSymbol = data[1] == appearArr[0] ? "ğŸ¥‡ " : data[1] == appearArr[1] ? "ğŸ¥ˆ " : data[1] == appearArr[2] ? "ğŸ¥‰ " : "";
    const winSymbol = data[1] == winArr[0] ? "ğŸ¥‡ " : data[1] == winArr[1] ? "ğŸ¥ˆ " : data[1] == winArr[2] ? "ğŸ¥‰ " : "";
    tr.innerHTML=`
      <td>${data[0]}</td>
      <td>${appearSymbol}${data[1]}</td>
      <td>${winSymbol}${data[2]}</td>
      <td>${data[3]}%</td>
      <td>${data[4]}%</td>
    `
    body.appendChild(tr)
  })
}

// ===== ç¼–ç  =====

function exportCode(){
  const data={v:1,r:currentRound,m:matches}
  const json=JSON.stringify(data)

  let big=0n
  for(let i=0;i<json.length;i++){
    big=big*256n+BigInt(json.charCodeAt(i))
  }

  let encoded=""
  while(big>0){
    encoded=chars[Number(big%62n)]+encoded
    big=big/62n
  }

  // å¦‚æœæ²¡æœ‰æ¯”èµ›æ•°æ®
  if(encoded==="") encoded="0"

  document.getElementById("codeArea").value=encoded
}

function importCode(){
  const code=document.getElementById("codeArea").value.trim()
  if(!code){
    alert("è¯·è¾“å…¥ç¼–ç ")
    return
  }

  let big=0n
  for(let i=0;i<code.length;i++){
    const index=chars.indexOf(code[i])
    if(index===-1){
      alert("ç¼–ç åŒ…å«éæ³•å­—ç¬¦")
      return
    }
    big=big*62n+BigInt(index)
  }

  let bytes=[]
  while(big>0){
    bytes.unshift(Number(big%256n))
    big=big/256n
  }

  try{
    const json=String.fromCharCode(...bytes)
    const data=JSON.parse(json)

    currentRound=data.r
    matches=data.m
    currentSelection={}
    resetButtons()
    updateStats()

  }catch(e){
    alert("ç¼–ç è§£æå¤±è´¥")
  }
}
// æ¸…ç©ºæ•°æ®
function clearData(){
  if(!confirm("ç¡®å®šæ¸…ç©ºå…¨éƒ¨æ•°æ®ï¼Ÿ")) return
  currentRound=1
  matches=[]
  currentSelection={}
  resetButtons()
  updateStats()
  document.getElementById("codeArea").value=""
}

// ä¿å­˜å›¾ç‰‡
function saveImage(){
  html2canvas(document.getElementById("resultArea")).then(canvas=>{
    const link=document.createElement("a")
    link.download="ç»Ÿè®¡ç»“æœ.png"
    link.href=canvas.toDataURL()
    link.click()
  })
}

updateStats()
</script>

</body>
</html>