<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>校园杀统计表</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
:root{
  --primary:#1677ff;
  --danger:#ff4d4f;
  --bg:#f5f7fa;
}

*{
  box-sizing:border-box;
  -webkit-tap-highlight-color: transparent;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);
  padding:16px;
}

h1{
  font-size:24px;
  margin-bottom:16px;
}

h2{
  font-size:20px;
  margin:0 0 12px 0;
}

.panel{
  background:#fff;
  padding:16px;
  border-radius:16px;
  box-shadow:0 6px 18px rgba(0,0,0,0.05);
  margin-bottom:16px;
}

/* ===== 角色网格 ===== */
.role-grid{
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:10px;
}

.role-btn{
  padding:12px 6px;
  border-radius:12px;
  border:1px solid #ddd;
  background:#fff;
  font-size:16px;
  font-weight:500;
  cursor:pointer;
  transition:0.15s;
}

.role-btn:active{
  transform:scale(0.96);
}

.role-btn.win{
  background:#d4f7dc;
  border-color:#30c46c;
}

.role-btn.lose{
  background:#ffd6d6;
  border-color:#ff4d4f;
}

/* ===== 操作按钮 ===== */
.main-btn{
  padding:14px;
  border-radius:12px;
  border:none;
  font-weight:600;
  font-size:18px;
  width:100%;
  margin-bottom:10px;
  cursor:pointer;
}

.primary{
  background:var(--primary);
  color:#fff;
}

.danger{
  background:var(--danger);
  color:#fff;
}

.gray{
  background:#f0f0f0;
}

/* ===== 表格移动优化 ===== */
#resultArea{
  overflow-x:auto;
}

table{
  width:100%;
  min-width:300px;
  border-collapse:collapse;
}

th,td{
  padding:8px;
  text-align:center;
  border-bottom:1px solid #eee;
  font-size:16px;
}

/* ===== 底部固定操作区（移动端）===== */
@media (max-width:768px){

  body{
    padding-bottom:90px;
  }

  .bottom-fixed{
    position:fixed;
    left:0;
    right:0;
    bottom:0;
    background:#fff;
    padding:12px 16px calc(12px + env(safe-area-inset-bottom));
    box-shadow:0 -6px 18px rgba(0,0,0,0.08);
  }

}
</style>
</head>
<body>

<h1>校园杀统计表</h1>

<div class="panel">
  <h2>第 <span id="roundDisplay">1</span> 场</h2>
  <div class="role-grid" id="roleGrid"></div>
  <br>
  <div class="bottom-fixed">
    <button class="main-btn primary" onclick="completeRound()">完成本场</button>
    <button class="main-btn gray" onclick="clearData()">清空数据</button>
  </div>
</div>

<div class="panel">
  <h2>统计结果</h2>
  <div id="resultArea">
    <table>
      <thead>
        <tr>
          <th>角色</th>
          <th>登场</th>
          <th>胜场</th>
          <th>胜率</th>
        </tr>
      </thead>
      <tbody id="resultBody"></tbody>
    </table>
  </div>
  <br>
  <button class="main-btn gray" onclick="saveImage()">保存为图片</button>
</div>

<div class="panel">
  <h2>导入 / 导出</h2>
  <textarea id="codeArea" style="width:100%;height:80px;"></textarea><br><br>
  <button class="main-btn primary" onclick="exportCode()">导出编码</button>
  <button class="main-btn primary" onclick="importCode()">导入编码</button>
</div>

<script>
const chars = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"

// ===== 角色列表 =====
const roles = [
  "白茹琴",
  "白云龙",
  "白梓钰",
  "包庆梅",
  "迟海鹰",
  "丛艳",
  "董福贤",
  "杜欣",
  "傅忠扬",
  "葛展廷",
  "顾伟利",
  "郭殷",
  "韩辉",
  "郝新明",
  "黄德彬",
  "姜翠梅",
  "姜声河",
  "金权伟",
  "金钟植",
  "李桂玲",
  "李嘉",
  "李君科",
  "李丽燕",
  "林中秋",
  "刘柏兵",
  "刘健",
  "刘静",
  "马宁",
  "马志科",
  "孟令斌",
  "孟艳",
  "潘静",
  "石磊",
  "孙彬",
  "孙冰",
  "孙桂艺",
  "孙艳梅",
  "陶阳",
  "万慧馨",
  "王然",
  "王瑞花",
  "王跃进",
  "邢珺",
  "杨光宇",
  "杨卉",
  "杨旭华",
  "于润泽",
  "张淑芳",
  "张昀",
  "赵德贤",
  "赵欣欣",
  "郑彤",
  "郑晓伟",
  "周杰",
  "朱刚琴",
  "朱晓东",
]

let currentRound = 1
let matches = []
let currentSelection = {}

const roleGrid = document.getElementById("roleGrid")

// 初始化角色按钮
roles.forEach((role,index)=>{
  const btn = document.createElement("button")
  btn.className = "role-btn"
  btn.innerText = role
  btn.onclick = ()=>toggleRole(index,btn)
  roleGrid.appendChild(btn)
})

// 点击循环：未选 → 胜 → 负 → 未选
function toggleRole(index,btn){
  if(!currentSelection[index]){
    currentSelection[index] = "win"
    btn.classList.add("win")
  }else if(currentSelection[index]==="win"){
    currentSelection[index] = "lose"
    btn.classList.remove("win")
    btn.classList.add("lose")
  }else{
    delete currentSelection[index]
    btn.classList.remove("lose")
  }
}

// 完成本场
function completeRound(){
  const win = []
  const lose = []
  for(const k in currentSelection){
    if(currentSelection[k]==="win") win.push(Number(k))
    if(currentSelection[k]==="lose") lose.push(Number(k))
  }

  if(win.length===0 && lose.length===0){
    alert("本场未选择角色")
    return
  }

  matches.push({w:win,l:lose})
  currentRound++
  currentSelection={}
  resetButtons()
  updateStats()
}

// 重置按钮状态
function resetButtons(){
  document.querySelectorAll(".role-btn").forEach(btn=>{
    btn.classList.remove("win")
    btn.classList.remove("lose")
  })
  document.getElementById("roundDisplay").innerText=currentRound
}

// 实时统计
function updateStats(){
  const stats = {}
  roles.forEach((r,i)=>{
    stats[i]={appear:0,win:0,lose:0}
  })

  matches.forEach(m=>{
    m.w.forEach(i=>{
      stats[i].appear++
      stats[i].win++
    })
    m.l.forEach(i=>{
      stats[i].appear++
      stats[i].lose++
    })
  })

  const body=document.getElementById("resultBody")
  body.innerHTML=""

  roles.forEach((r,i)=>{
    if(stats[i].appear>0){
      const tr=document.createElement("tr")
      tr.innerHTML=`
        <td>${r}</td>
        <td>${stats[i].appear}</td>
        <td>${stats[i].win}</td>
        <td>${Math.round(100 * stats[i].win / (stats[i].win + stats[i].lose))}%</td>
      `
      body.appendChild(tr)
    }
  })
}

// ===== 编码 =====

function exportCode(){
  const data={v:1,r:currentRound,m:matches}
  const json=JSON.stringify(data)

  let big=0n
  for(let i=0;i<json.length;i++){
    big=big*256n+BigInt(json.charCodeAt(i))
  }

  let encoded=""
  while(big>0){
    encoded=chars[Number(big%62n)]+encoded
    big=big/62n
  }

  // 如果没有比赛数据
  if(encoded==="") encoded="0"

  document.getElementById("codeArea").value=encoded
}

function importCode(){
  const code=document.getElementById("codeArea").value.trim()
  if(!code){
    alert("请输入编码")
    return
  }

  let big=0n
  for(let i=0;i<code.length;i++){
    const index=chars.indexOf(code[i])
    if(index===-1){
      alert("编码包含非法字符")
      return
    }
    big=big*62n+BigInt(index)
  }

  let bytes=[]
  while(big>0){
    bytes.unshift(Number(big%256n))
    big=big/256n
  }

  try{
    const json=String.fromCharCode(...bytes)
    const data=JSON.parse(json)

    currentRound=data.r
    matches=data.m
    currentSelection={}
    resetButtons()
    updateStats()

  }catch(e){
    alert("编码解析失败")
  }
}
// 清空数据
function clearData(){
  if(!confirm("确定清空全部数据？")) return
  currentRound=1
  matches=[]
  currentSelection={}
  resetButtons()
  updateStats()
  document.getElementById("codeArea").value=""
}

// 保存图片
function saveImage(){
  html2canvas(document.getElementById("resultArea")).then(canvas=>{
    const link=document.createElement("a")
    link.download="统计结果.png"
    link.href=canvas.toDataURL()
    link.click()
  })
}

updateStats()
</script>

</body>
</html>